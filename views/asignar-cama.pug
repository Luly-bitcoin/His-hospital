extends layout

block content
  head
    title Asignar Cama
    link(rel="stylesheet", href="/css/style.css")
    style.
      body {
        font-family: 'Segoe UI', sans-serif;
        background: linear-gradient(to bottom, #7dbcff, rgba(255,255,255,0.8)), url('/img/hospital2.jpg');
        background-repeat: no-repeat;
        background-size: cover;
        background-position: center;
        margin: 0;
        display: flex;
        justify-content: center;
        align-items: flex-start;
        padding: 40px 0;
      }
      select {
        width: 100%;
      }
      .input-group {
        margin-bottom: 15px;
      }

  .contenedor
    img.logo-flotante(src="/img/logo.png", alt="Logo")
    br
    br
    .formulario-box
      h1 Asignar cama a paciente
      p Paciente: #{nombre} (DNI: #{dni}), Sexo: #{sexo}

      form(id="asignarCamaForm", method="POST", action="/internaciones/asignar")
        .input-group
          label(for="tipo_ingreso") Tipo de Ingreso
          select(name="tipo_ingreso", id="tipo_ingreso", required)
            option(value="") Seleccionar
            option(value="guardia") Guardia
            option(value="derivacion-medica") Derivacion Medica 
            option(value="cita-programada") Cita Programada 
            option(value="emergencias") Emergencias 

        .input-group
          label(for="fecha_ingreso") Fecha de Ingreso
          input(type="datetime-local", id="fecha_ingreso", name="fecha_ingreso", required, value=new Date().toISOString().slice(0,16))

        .input-group
          label(for="ala") Seleccionar Ala
          select#selectAla(name="ala", required)
            option(value="") Seleccionar Ala
            each ala in alas 
                option(value=ala.id) #{ala.nombre}

        .input-group
          label(for="habitacion") Seleccionar Habitación
          select#selectHabitacion(name="habitacion", disabled, required)
            option(value="") Primero seleccione un Ala

        .input-group
          label(for="cama") Seleccionar Cama
          select#selectCama(name="camaId", disabled, required)
            option(value="") Primero seleccione una Habitación

        input(type="hidden", name="pacienteId", id="pacienteId", value=dniPaciente)
        input(type="hidden", name="sexo", value=sexoPaciente)

        button#btnAsignar(type="submit", class="boton") Asignar Cama
    
    script.
        const selectCama = document.getElementById('selectCama');
        const selectHabitacion = document.getElementById('selectHabitacion');

        selectHabitacion.addEventListener('change', () => {
          const habitacionId = selectHabitacion.value;
          if (!habitacionId) {
            selectCama.innerHTML = '<option value="">Primero seleccione una Habitación</option>';
            selectCama.disabled = true;
            return;
          }

          fetch(`/api/camas?habitacionId=${habitacionId}&estado=libre`)
            .then(res => res.json())
            .then(camas => {
              selectCama.innerHTML = '';
              if(camas.length === 0) {
                const option = document.createElement('option');
                option.value = '';
                option.textContent = 'No hay camas libres';
                selectCama.appendChild(option);
                selectCama.disabled = true;
              } else {
                const defaultOption = document.createElement('option');
                defaultOption.value = '';
                defaultOption.textContent = 'Seleccionar cama';
                selectCama.appendChild(defaultOption);

                camas.forEach(cama => {
                  const option = document.createElement('option');
                  option.value = cama.id;
                  option.textContent = `Cama ${cama.id}`;
                  selectCama.appendChild(option);
                });
                selectCama.disabled = false;
              }
            })
            .catch(err => {
              console.error(err);
              alert('Error al cargar camas');
            });
        });

